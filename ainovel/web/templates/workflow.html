{% extends "base.html" %}

{% block title %}{{ novel.title }} - åˆ›ä½œæµç¨‹{% endblock %}

{% block extra_head %}
<style>
.step-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px; height: 28px;
    border-radius: 50%;
    font-weight: bold;
    font-size: 13px;
    margin-right: 8px;
    flex-shrink: 0;
}
.step-badge.done   { background: #27ae60; color: white; }
.step-badge.active { background: #3498db; color: white; }
.step-badge.todo   { background: #ecf0f1; color: #95a5a6; border: 2px solid #ddd; }

.step-header {
    display: flex;
    align-items: center;
    margin-bottom: 14px;
}
.step-header h3 { margin: 0; font-size: 16px; }

.result-box {
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 14px;
    margin-top: 12px;
    white-space: pre-wrap;
    font-size: 13px;
    line-height: 1.7;
    max-height: 320px;
    overflow-y: auto;
}

.htmx-request .spinner-inline { display: inline-block !important; }
.spinner-inline {
    display: none;
    width: 16px; height: 16px;
    border: 2px solid #ccc;
    border-top-color: #3498db;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    vertical-align: middle;
    margin-left: 8px;
}
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 16px;">
    <a href="/" style="color: #3498db; text-decoration: none;">â† è¿”å›åˆ—è¡¨</a>
    &nbsp;&nbsp;
    <a href="/novels/view/{{ novel.id }}" style="color: #3498db; text-decoration: none;">é¡¹ç›®è¯¦æƒ…</a>
</div>

<div class="card" style="padding: 16px 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 style="margin-bottom: 4px;">ğŸ“– {{ novel.title }}</h2>
            <span style="color: #7f8c8d; font-size: 13px;">ä½œè€…ï¼š{{ novel.author }} | ç±»å‹ï¼š{{ novel.genre or 'æœªè®¾ç½®' }}</span>
        </div>
        <span style="font-size: 13px; color: #7f8c8d;">æ­¥éª¤ {{ novel.current_step }}/6 &nbsp;Â·&nbsp; {{ novel.workflow_status }}</span>
    </div>
</div>

<!-- æ­¥éª¤1ï¼šåˆ›ä½œæ€è·¯ -->
<div class="card">
    <div class="step-header">
        <span class="step-badge {% if novel.current_step > 1 %}done{% elif novel.current_step == 1 %}active{% else %}todo{% endif %}">1</span>
        <h3>åˆ›ä½œæ€è·¯</h3>
    </div>
    <form hx-post="/workflow/{{ novel.id }}/step1"
          hx-target="#step1-result"
          hx-swap="innerHTML"
          hx-indicator="#step1-spinner">
        <textarea name="initial_idea" placeholder="è¾“å…¥åˆå§‹æƒ³æ³•ï¼ˆç•™ç©ºåˆ™ä½¿ç”¨å°è¯´æè¿°ï¼‰" style="min-height: 80px;">{{ novel.description or '' }}</textarea>
        <button type="submit" class="btn">ç”Ÿæˆåˆ›ä½œæ€è·¯
            <span id="step1-spinner" class="spinner-inline"></span>
        </button>
    </form>
    <div id="step1-result" class="result-box" style="display: none;"></div>
</div>

<!-- æ­¥éª¤2ï¼šä¸–ç•Œè§‚å’Œè§’è‰² -->
<div class="card">
    <div class="step-header">
        <span class="step-badge {% if novel.current_step > 2 %}done{% elif novel.current_step == 2 %}active{% else %}todo{% endif %}">2</span>
        <h3>ä¸–ç•Œè§‚å’Œè§’è‰²</h3>
    </div>
    <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 12px;">åŸºäºåˆ›ä½œæ€è·¯ï¼Œè‡ªåŠ¨ç”Ÿæˆä¸–ç•Œè§‚è®¾å®šå’Œä¸»è¦è§’è‰²ã€‚</p>
    <button hx-post="/workflow/{{ novel.id }}/step2"
            hx-target="#step2-result"
            hx-swap="innerHTML"
            hx-indicator="#step2-spinner"
            class="btn">ç”Ÿæˆä¸–ç•Œè§‚å’Œè§’è‰²
        <span id="step2-spinner" class="spinner-inline"></span>
    </button>
    <div id="step2-result" class="result-box" style="display: none;"></div>
</div>

<!-- æ­¥éª¤3ï¼šå¤§çº² -->
<div class="card">
    <div class="step-header">
        <span class="step-badge {% if novel.current_step > 3 %}done{% elif novel.current_step == 3 %}active{% else %}todo{% endif %}">3</span>
        <h3>ç”Ÿæˆå¤§çº²</h3>
    </div>
    <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 12px;">ç”Ÿæˆåˆ†å·åˆ†ç« çš„æ•´ä½“å¤§çº²ç»“æ„ã€‚</p>
    <button hx-post="/workflow/{{ novel.id }}/step3"
            hx-target="#step3-result"
            hx-swap="innerHTML"
            hx-indicator="#step3-spinner"
            class="btn">ç”Ÿæˆå¤§çº²
        <span id="step3-spinner" class="spinner-inline"></span>
    </button>
    <div id="step3-result" class="result-box" style="display: none;"></div>
</div>

<!-- æ­¥éª¤4ï¼šæ‰¹é‡ç»†çº² -->
<div class="card">
    <div class="step-header">
        <span class="step-badge {% if novel.current_step > 4 %}done{% elif novel.current_step == 4 %}active{% else %}todo{% endif %}">4</span>
        <h3>æ‰¹é‡ç”Ÿæˆç»†çº²</h3>
    </div>
    <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 12px;">ä¸ºæ‰€æœ‰ç« èŠ‚æ‰¹é‡ç”Ÿæˆè¯¦ç»†ç»†çº²ï¼ˆåœºæ™¯ã€å†²çªã€èŠ‚å¥ï¼‰ã€‚</p>
    <button hx-post="/workflow/{{ novel.id }}/step4/batch"
            hx-target="#step4-result"
            hx-swap="innerHTML"
            hx-indicator="#step4-spinner"
            class="btn">æ‰¹é‡ç”Ÿæˆç»†çº²
        <span id="step4-spinner" class="spinner-inline"></span>
    </button>
    <div id="step4-result" class="result-box" style="display: none;"></div>
</div>

<!-- æ­¥éª¤5ï¼šç« èŠ‚åˆ›ä½œ -->
<div class="card">
    <div class="step-header">
        <span class="step-badge {% if novel.current_step > 5 %}done{% elif novel.current_step == 5 %}active{% else %}todo{% endif %}">5</span>
        <h3>ç« èŠ‚åˆ›ä½œ</h3>
    </div>
    <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 12px;">è¾“å…¥ç« èŠ‚ ID ç”Ÿæˆæ­£æ–‡å†…å®¹ã€‚å¯é€‰å¡«å†™é£æ ¼æŒ‡å—è¦†ç›–é»˜è®¤æ–‡é£ã€‚</p>
    <form hx-post="/workflow/chapter/1/step5"
          hx-target="#step5-result"
          hx-swap="innerHTML"
          hx-indicator="#step5-spinner"
          id="step5-form"
          onsubmit="updateStep5Action(this)">
        <div style="display: flex; gap: 10px; margin-bottom: 0;">
            <input type="number" id="step5-chapter-id" name="_chapter_id" placeholder="ç« èŠ‚ ID" min="1" style="width: 140px; margin-bottom: 15px;" required>
            <input type="text" name="style_guide" placeholder="é£æ ¼æŒ‡å—ï¼ˆå¯é€‰ï¼Œå¦‚ï¼šé‡‘åº¸æ­¦ä¾ é£ï¼‰" style="flex: 1; margin-bottom: 15px;">
        </div>
        <button type="submit" class="btn">ç”Ÿæˆç« èŠ‚å†…å®¹
            <span id="step5-spinner" class="spinner-inline"></span>
        </button>
    </form>
    <div id="step5-result" class="result-box" style="display: none;"></div>
</div>

<!-- æ­¥éª¤6ï¼šè´¨é‡æ£€æŸ¥ -->
<div class="card">
    <div class="step-header">
        <span class="step-badge {% if novel.current_step >= 6 %}done{% else %}todo{% endif %}">6</span>
        <h3>è´¨é‡æ£€æŸ¥</h3>
    </div>
    <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 12px;">å¯¹å·²ç”Ÿæˆç« èŠ‚è¿›è¡Œè´¨é‡è¯„ä¼°ï¼Œæˆ–æ‰¹é‡æ£€æŸ¥æ‰€æœ‰ç« èŠ‚ã€‚</p>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <form style="display: flex; gap: 8px; align-items: flex-end;"
              hx-post="/workflow/chapter/1/step6"
              hx-target="#step6-result"
              hx-swap="innerHTML"
              hx-indicator="#step6-spinner"
              onsubmit="updateStep6Action(this)">
            <input type="number" id="step6-chapter-id" name="_chapter_id" placeholder="ç« èŠ‚ ID" min="1" style="width: 140px; margin-bottom: 0;" required>
            <button type="submit" class="btn" style="white-space: nowrap;">æ£€æŸ¥å•ç« </button>
        </form>
        <button hx-post="/workflow/{{ novel.id }}/step6/batch"
                hx-target="#step6-result"
                hx-swap="innerHTML"
                hx-indicator="#step6-spinner"
                class="btn btn-success">æ‰¹é‡æ£€æŸ¥æ‰€æœ‰ç« èŠ‚
            <span id="step6-spinner" class="spinner-inline"></span>
        </button>
    </div>
    <div id="step6-result" class="result-box" style="display: none;"></div>
</div>

<!-- æ–‡é£å­¦ä¹  -->
<div class="card">
    <div class="step-header">
        <span class="step-badge active" style="background: #9b59b6;">âœ¦</span>
        <h3>æ–‡é£å­¦ä¹ </h3>
    </div>
    <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 12px;">ä¸Šä¼ å‚è€ƒæ–‡æœ¬ï¼ŒAI æå–å†™ä½œé£æ ¼å¹¶ä¿å­˜ä¸ºæ¡£æ¡ˆï¼Œåç»­ç« èŠ‚ç”Ÿæˆè‡ªåŠ¨åº”ç”¨ã€‚</p>

    <!-- å­¦ä¹ æ–‡é£ -->
    <form hx-post="/workflow/{{ novel.id }}/style/learn"
          hx-target="#style-result"
          hx-swap="innerHTML"
          hx-indicator="#style-spinner"
          style="margin-bottom: 16px;">
        <input type="text" name="name" placeholder="æ¡£æ¡ˆåç§°ï¼ˆå¦‚ï¼šé‡‘åº¸æ­¦ä¾ é£ï¼‰" required>
        <textarea name="source_text" placeholder="ç²˜è´´å‚è€ƒæ–‡æœ¬ï¼ˆå»ºè®®500å­—ä»¥ä¸Šï¼‰" style="min-height: 120px;" required></textarea>
        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px; font-size: 13px; cursor: pointer;">
            <input type="checkbox" name="set_active" value="true" checked style="width: auto; margin: 0;">
            å­¦ä¹ åç«‹å³æ¿€æ´»æ­¤æ¡£æ¡ˆ
        </label>
        <button type="submit" class="btn" style="background: #9b59b6;">åˆ†æå¹¶ä¿å­˜æ–‡é£
            <span id="style-spinner" class="spinner-inline"></span>
        </button>
    </form>

    <!-- æŸ¥çœ‹æ¡£æ¡ˆåˆ—è¡¨ -->
    <button hx-get="/workflow/{{ novel.id }}/style/profiles"
            hx-target="#style-result"
            hx-swap="innerHTML"
            class="btn" style="background: #7f8c8d; font-size: 13px;">æŸ¥çœ‹å·²æœ‰æ¡£æ¡ˆ</button>

    <div id="style-result" class="result-box" style="display: none;"></div>
</div>

<!-- æ ‡è®°å®Œæˆ -->
<div class="card" style="text-align: center; padding: 24px;">
    <p style="color: #7f8c8d; margin-bottom: 16px;">æ‰€æœ‰æ­¥éª¤å®Œæˆåï¼Œæ ‡è®°å°è¯´åˆ›ä½œå®Œæˆã€‚</p>
    <button hx-post="/workflow/{{ novel.id }}/complete"
            hx-target="#complete-result"
            hx-swap="innerHTML"
            hx-confirm="ç¡®è®¤æ ‡è®°ã€Š{{ novel.title }}ã€‹åˆ›ä½œå®Œæˆï¼Ÿ"
            class="btn btn-success">æ ‡è®°åˆ›ä½œå®Œæˆ</button>
    <div id="complete-result" style="margin-top: 12px;"></div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
/* åŠ¨æ€æ›´æ–° step5 çš„ action URL */
function updateStep5Action(form) {
    const id = document.getElementById('step5-chapter-id').value;
    form.setAttribute('hx-post', `/workflow/chapter/${id}/step5`);
    htmx.process(form);
}

/* åŠ¨æ€æ›´æ–° step6 å•ç« çš„ action URL */
function updateStep6Action(form) {
    const id = document.getElementById('step6-chapter-id').value;
    form.setAttribute('hx-post', `/workflow/chapter/${id}/step6`);
    htmx.process(form);
}

/* æœ‰ç»“æœæ—¶è‡ªåŠ¨æ˜¾ç¤º result-box */
document.body.addEventListener('htmx:afterSwap', function(evt) {
    const target = evt.detail.target;
    if (target && target.classList.contains('result-box')) {
        if (target.innerHTML.trim()) {
            target.style.display = 'block';
        }
    }
});

/* å°† JSON å“åº”æ ¼å¼åŒ–æ˜¾ç¤º */
document.body.addEventListener('htmx:beforeSwap', function(evt) {
    const ct = evt.detail.xhr.getResponseHeader('content-type') || '';
    if (ct.includes('application/json')) {
        try {
            const json = JSON.parse(evt.detail.serverResponse);
            evt.detail.serverResponse = '<pre>' + JSON.stringify(json, null, 2) + '</pre>';
        } catch(e) {}
    }
});
</script>
{% endblock %}

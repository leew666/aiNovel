{% extends "base.html" %}

{% block title %}{{ novel.title }} - é¡¹ç›®è¯¦æƒ…{% endblock %}

{% block extra_head %}
<style>
.step-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 26px; height: 26px;
    border-radius: 50%;
    font-weight: 600;
    font-size: 12px;
    margin-right: 8px;
    flex-shrink: 0;
}
.step-badge.done   { background: #34C759; color: white; }
.step-badge.active { background: #007AFF; color: white; }
.step-badge.todo   { background: rgba(120,120,128,0.12); color: #8e8e93; }

.step-header {
    display: flex;
    align-items: center;
    margin-bottom: 14px;
}
.step-header h3 { margin: 0; font-size: 15px; font-weight: 600; letter-spacing: -0.2px; }

.result-box {
    background: #f2f2f7;
    border-radius: 10px;
    padding: 14px;
    margin-top: 10px;
    white-space: pre-wrap;
    font-size: 13px;
    line-height: 1.7;
    max-height: 320px;
    overflow-y: auto;
    color: #3a3a3c;
}

.htmx-request .spinner-inline { display: inline-block !important; }
.spinner-inline {
    display: none;
    width: 14px; height: 14px;
    border: 2px solid rgba(255,255,255,0.4);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    vertical-align: middle;
    margin-left: 6px;
}

/* æ­¥éª¤è¿›åº¦æ¡ */
.steps-progress {
    display: flex;
    align-items: center;
    padding: 16px;
    background: #f2f2f7;
    border-radius: 12px;
    margin-bottom: 20px;
}
.steps-progress .step-node {
    text-align: center;
    flex-shrink: 0;
}
.steps-progress .step-line {
    flex: 1;
    height: 2px;
    margin: 0 4px;
    margin-bottom: 20px;
    border-radius: 1px;
}

/* è¿›å…¥åˆ›ä½œæŒ‰é’®åŒºåŸŸ */
.enter-editor-banner {
    background: linear-gradient(135deg, #007AFF, #0051d5);
    border-radius: 14px;
    padding: 18px 22px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    color: white;
    margin-bottom: 8px;
}
.enter-editor-banner h3 { margin: 0 0 3px; font-size: 15px; font-weight: 600; }
.enter-editor-banner p  { margin: 0; font-size: 13px; opacity: 0.8; }

/* Segmented control é£æ ¼ tab */
.input-mode-tabs {
    display: inline-flex;
    background: rgba(120,120,128,0.12);
    border-radius: 9px;
    padding: 2px;
    margin-bottom: 14px;
    gap: 0;
}
.input-mode-tab {
    padding: 5px 16px;
    border-radius: 7px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    background: transparent;
    color: #3a3a3c;
    transition: background 0.18s ease, color 0.18s ease;
}
.input-mode-tab.active {
    background: white;
    color: #1c1c1e;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
}
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 16px;">
    <a href="/" style="color: #3498db; text-decoration: none;">â† è¿”å›åˆ—è¡¨</a>
</div>

<!-- é¡¹ç›®ä¿¡æ¯å¤´éƒ¨ -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
            <h2>ğŸ“– {{ novel.title }}</h2>
            <p style="color: #7f8c8d; margin-top: 6px;">
                ä½œè€…ï¼š{{ novel.author }} &nbsp;|&nbsp;
                ç±»å‹ï¼š{{ novel.genre or 'æœªè®¾ç½®' }} &nbsp;|&nbsp;
                åˆ›å»ºï¼š{{ novel.created_at.strftime('%Y-%m-%d') }}
            </p>
            {% if novel.description %}
            <p style="margin-top: 10px; color: #555;">{{ novel.description }}</p>
            {% endif %}
        </div>
        <a href="/novels/{{ novel.id }}/characters" class="btn" style="background: #8e44ad; flex-shrink: 0;">è§’è‰²å¡</a>
    </div>
</div>

<!-- ä¸€é”®å…¨æµç¨‹ç”Ÿæˆ -->
{% if novel.workflow_status.value == 'completed' %}
<div id="full-run-area" class="card" style="border-left: 4px solid #27ae60;">
    <h3 style="color:#27ae60; margin-bottom:12px;">âœ“ å…¨éƒ¨æ­¥éª¤å·²å®Œæˆ</h3>
    <p style="color:#7f8c8d; font-size:13px; margin-bottom:12px;">åˆ›ä½œæµç¨‹å·²å…¨éƒ¨å®Œæˆï¼Œå¯è¿›å…¥ç« èŠ‚ç¼–è¾‘å™¨æŸ¥çœ‹ç»“æœã€‚</p>
    <a href="/novels/editor/{{ novel.id }}" class="btn">è¿›å…¥ç« èŠ‚ç¼–è¾‘å™¨ â†’</a>
</div>
{% else %}
<div id="full-run-area" class="card">
    <h3 style="margin-bottom:6px;">ä¸€é”®å…¨æµç¨‹ç”Ÿæˆ</h3>
    <p style="color:#7f8c8d; font-size:13px; margin-bottom:14px;">
        è¾“å…¥åˆå§‹æƒ³æ³•ï¼Œç³»ç»Ÿè‡ªåŠ¨ä¾æ¬¡å®Œæˆï¼šåˆ›ä½œæ€è·¯ â†’ ä¸–ç•Œè§‚è§’è‰² â†’ å¤§çº² â†’ ç»†çº² â†’ ç« èŠ‚æ­£æ–‡
    </p>
    <form hx-post="/workflow/{{ novel.id }}/full-run"
          hx-target="#full-run-area"
          hx-swap="outerHTML"
          hx-ext="json-enc"
          hx-indicator="#full-run-spinner">
        <textarea name="initial_idea"
                  placeholder="è¾“å…¥æ‚¨çš„åˆ›ä½œæƒ³æ³•ï¼ˆç•™ç©ºåˆ™ä½¿ç”¨å°è¯´æè¿°ï¼‰..."
                  style="min-height: 80px;">{{ novel.description or '' }}</textarea>
        <button type="submit" class="btn" style="background:#27ae60; margin-top:8px;">
            å¼€å§‹å…¨æµç¨‹ç”Ÿæˆ
            <span id="full-run-spinner" class="spinner-inline"></span>
        </button>
    </form>
</div>
{% endif %}

<!-- ç»Ÿè®¡ä¿¡æ¯ -->
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px;">
    <div class="card" style="text-align: center; padding: 16px;">
        <div style="font-size: 28px; font-weight: bold; color: #3498db;">{{ volumes_count }}</div>
        <div style="color: #7f8c8d; font-size: 13px; margin-top: 4px;">å·æ•°</div>
    </div>
    <div class="card" style="text-align: center; padding: 16px;">
        <div style="font-size: 28px; font-weight: bold; color: #27ae60;">{{ chapters_count }}</div>
        <div style="color: #7f8c8d; font-size: 13px; margin-top: 4px;">ç« èŠ‚æ•°</div>
    </div>
    <div class="card" style="text-align: center; padding: 16px;">
        <div style="font-size: 28px; font-weight: bold; color: #e67e22;">{{ total_words }}</div>
        <div style="color: #7f8c8d; font-size: 13px; margin-top: 4px;">æ€»å­—æ•°</div>
    </div>
</div>

<!-- æ•´ä½“è¿›åº¦æ¡ -->
<div class="card">
    <h3 style="margin-bottom: 16px;">å‰ç½®å·¥ä½œæµè¿›åº¦</h3>
    <div class="steps-progress">
        {% set steps = [('1','åˆ›ä½œæ€è·¯'), ('2','ä¸–ç•Œè§‚è§’è‰²'), ('3','ç”Ÿæˆå¤§çº²'), ('4','æ‰¹é‡ç»†çº²')] %}
        {% for num, label in steps %}
        <div class="step-node">
            <div style="width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 6px;
                {% if novel.current_step > num|int %}background: #27ae60; color: white;
                {% elif novel.current_step == num|int %}background: #3498db; color: white;
                {% else %}background: white; color: #95a5a6; border: 2px solid #ddd;{% endif %}
                font-weight: bold; font-size: 14px;">{{ num }}</div>
            <div style="font-size: 12px; color: {% if novel.current_step >= num|int %}#2c3e50{% else %}#95a5a6{% endif %};">{{ label }}</div>
        </div>
        {% if not loop.last %}
        <div class="step-line" style="background: {% if novel.current_step > loop.index %}#27ae60{% else %}#ddd{% endif %};"></div>
        {% endif %}
        {% endfor %}
    </div>
    <div style="text-align: center; color: #7f8c8d; font-size: 13px;">
        å½“å‰çŠ¶æ€ï¼š{{ novel.workflow_status }}
    </div>
</div>

<!-- æ­¥éª¤1ï¼šåˆ›ä½œæ€è·¯ -->
<div class="card">
    <div class="step-header">
        <span class="step-badge {% if novel.current_step > 1 %}done{% elif novel.current_step == 1 %}active{% else %}todo{% endif %}">1</span>
        <h3>åˆ›ä½œæ€è·¯</h3>
    </div>

    <div class="input-mode-tabs">
        <button class="input-mode-tab active" onclick="switchMode('step1', 'ai', this)">AI ç”Ÿæˆ</button>
        <button class="input-mode-tab" onclick="switchMode('step1', 'manual', this)">æ‰‹åŠ¨è¾“å…¥</button>
    </div>

    <!-- AI ç”Ÿæˆæ¨¡å¼ -->
    <div id="step1-ai-mode">
        <form hx-post="/workflow/{{ novel.id }}/step1"
              hx-target="#step1-result"
              hx-swap="innerHTML"
              hx-indicator="#step1-spinner"
              hx-ext="json-enc">
            <textarea name="initial_idea" placeholder="è¾“å…¥åˆå§‹æƒ³æ³•ï¼ˆç•™ç©ºåˆ™ä½¿ç”¨å°è¯´æè¿°ï¼‰" style="min-height: 80px;">{{ novel.description or '' }}</textarea>
            <button type="submit" class="btn">AI ç”Ÿæˆåˆ›ä½œæ€è·¯
                <span id="step1-spinner" class="spinner-inline"></span>
            </button>
        </form>
    </div>

    <!-- æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ -->
    <div id="step1-manual-mode" style="display: none;">
        <form hx-put="/workflow/{{ novel.id }}/step1"
              hx-target="#step1-result"
              hx-swap="innerHTML"
              hx-ext="json-enc">
            <textarea name="planning_content" placeholder="ç›´æ¥è¾“å…¥åˆ›ä½œæ€è·¯å†…å®¹..." style="min-height: 120px;">{{ novel.planning_content or '' }}</textarea>
            <button type="submit" class="btn btn-success">ä¿å­˜åˆ›ä½œæ€è·¯</button>
        </form>
    </div>

    <div id="step1-result" class="result-box" {% if not novel.planning_content %}style="display:none;"{% endif %}>
        {% if novel.planning_content %}{{ novel.planning_content }}{% endif %}
    </div>
</div>

<!-- æ­¥éª¤2ï¼šä¸–ç•Œè§‚å’Œè§’è‰² -->
<div class="card">
    <div class="step-header">
        <span class="step-badge {% if novel.current_step > 2 %}done{% elif novel.current_step == 2 %}active{% else %}todo{% endif %}">2</span>
        <h3>ä¸–ç•Œè§‚å’Œè§’è‰²</h3>
    </div>

    <div class="input-mode-tabs">
        <button class="input-mode-tab active" onclick="switchMode('step2', 'ai', this)">AI ç”Ÿæˆ</button>
        <button class="input-mode-tab" onclick="switchMode('step2', 'manual', this)">æ‰‹åŠ¨è¾“å…¥</button>
    </div>

    <!-- AI ç”Ÿæˆæ¨¡å¼ -->
    <div id="step2-ai-mode">
        <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 12px;">åŸºäºåˆ›ä½œæ€è·¯ï¼Œè‡ªåŠ¨ç”Ÿæˆä¸–ç•Œè§‚è®¾å®šå’Œä¸»è¦è§’è‰²ã€‚</p>
        <button hx-post="/workflow/{{ novel.id }}/step2"
                hx-target="#step2-result"
                hx-swap="innerHTML"
                hx-indicator="#step2-spinner"
                class="btn">AI ç”Ÿæˆä¸–ç•Œè§‚å’Œè§’è‰²
            <span id="step2-spinner" class="spinner-inline"></span>
        </button>
    </div>

    <!-- æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ -->
    <div id="step2-manual-mode" style="display: none;">
        <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 12px;">æ‰‹åŠ¨è¾“å…¥ä¸–ç•Œè§‚è®¾å®šåï¼Œå¯å‰å¾€<a href="/novels/{{ novel.id }}/characters" style="color: #8e44ad;">è§’è‰²å¡</a>æ‰‹åŠ¨æ–°å¢è§’è‰²ã€‚</p>
        <form hx-put="/workflow/{{ novel.id }}/step2"
              hx-target="#step2-result"
              hx-swap="innerHTML"
              hx-ext="json-enc">
            <textarea name="world_building_content" placeholder="è¾“å…¥ä¸–ç•Œè§‚è®¾å®šå†…å®¹..." style="min-height: 120px;">{{ novel.world_building_raw or '' }}</textarea>
            <button type="submit" class="btn btn-success">ä¿å­˜ä¸–ç•Œè§‚è®¾å®š</button>
        </form>
    </div>

    <div id="step2-result" class="result-box" {% if not novel.world_building_raw %}style="display:none;"{% endif %}>
        {% if novel.world_building_raw %}{{ novel.world_building_raw }}{% endif %}
    </div>
</div>

<!-- æ­¥éª¤3ï¼šå¤§çº² -->
<div class="card">
    <div class="step-header">
        <span class="step-badge {% if novel.current_step > 3 %}done{% elif novel.current_step == 3 %}active{% else %}todo{% endif %}">3</span>
        <h3>ç”Ÿæˆå¤§çº²</h3>
    </div>

    <div class="input-mode-tabs">
        <button class="input-mode-tab active" onclick="switchMode('step3', 'ai', this)">AI ç”Ÿæˆ</button>
        <button class="input-mode-tab" onclick="switchMode('step3', 'manual', this)">æ‰‹åŠ¨è¾“å…¥</button>
    </div>

    <!-- AI ç”Ÿæˆæ¨¡å¼ -->
    <div id="step3-ai-mode">
        <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 12px;">ç”Ÿæˆåˆ†å·åˆ†ç« çš„æ•´ä½“å¤§çº²ç»“æ„ã€‚</p>
        <button hx-post="/workflow/{{ novel.id }}/step3"
                hx-target="#step3-result"
                hx-swap="innerHTML"
                hx-indicator="#step3-spinner"
                class="btn">AI ç”Ÿæˆå¤§çº²
            <span id="step3-spinner" class="spinner-inline"></span>
        </button>
    </div>

    <!-- æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ -->
    <div id="step3-manual-mode" style="display: none;">
        <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 12px;">æ‰‹åŠ¨è¾“å…¥å¤§çº²åï¼Œç³»ç»Ÿå°†è§£æå·/ç« èŠ‚ç»“æ„ã€‚æ ¼å¼ï¼šæ¯è¡Œä¸€ä¸ªç« èŠ‚ï¼Œç”¨"ç¬¬Xå·"æ ‡è®°åˆ†å·ã€‚</p>
        <textarea id="step3-manual-text" placeholder="ç¬¬ä¸€å· èµ·æº&#10;ç¬¬ä¸€ç«  å¼€å§‹&#10;ç¬¬äºŒç«  å‘å±•&#10;&#10;ç¬¬äºŒå· é«˜æ½®&#10;ç¬¬ä¸‰ç«  è½¬æŠ˜" style="min-height: 160px; font-family: monospace;"></textarea>
        <button class="btn btn-success" onclick="saveStep3Manual()">ä¿å­˜å¤§çº²</button>
    </div>

    <div id="step3-result" class="result-box" style="display: none;"></div>
</div>

<!-- æ­¥éª¤4ï¼šæ‰¹é‡ç»†çº² -->
<div class="card">
    <div class="step-header">
        <span class="step-badge {% if novel.current_step > 4 %}done{% elif novel.current_step == 4 %}active{% else %}todo{% endif %}">4</span>
        <h3>æ‰¹é‡ç”Ÿæˆç»†çº²</h3>
    </div>

    <div class="input-mode-tabs">
        <button class="input-mode-tab active" onclick="switchMode('step4', 'ai', this)">AI æ‰¹é‡ç”Ÿæˆ</button>
        <button class="input-mode-tab" onclick="switchMode('step4', 'manual', this)">é€ç« æ‰‹åŠ¨</button>
    </div>

    <!-- AI æ‰¹é‡ç”Ÿæˆæ¨¡å¼ -->
    <div id="step4-ai-mode">
        <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 12px;">ä¸ºæ‰€æœ‰ç« èŠ‚æ‰¹é‡ç”Ÿæˆè¯¦ç»†ç»†çº²ï¼ˆåœºæ™¯ã€å†²çªã€èŠ‚å¥ï¼‰ã€‚</p>
        <button hx-post="/workflow/{{ novel.id }}/step4/batch"
                hx-target="#step4-result"
                hx-swap="innerHTML"
                hx-indicator="#step4-spinner"
                class="btn">AI æ‰¹é‡ç”Ÿæˆç»†çº²
            <span id="step4-spinner" class="spinner-inline"></span>
        </button>
    </div>

    <!-- é€ç« æ‰‹åŠ¨æ¨¡å¼ -->
    <div id="step4-manual-mode" style="display: none;">
        <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 12px;">é€‰æ‹©ç« èŠ‚åè¿›å…¥ç« èŠ‚ç¼–è¾‘å™¨ï¼Œå¯åœ¨å³ä¾§æ‰‹åŠ¨å¡«å†™ç»†çº²ã€‚</p>
        {% if chapters_count > 0 %}
        <p style="font-size: 13px; color: #27ae60;">âœ“ å·²æœ‰ {{ chapters_count }} ä¸ªç« èŠ‚ï¼Œå¯è¿›å…¥ç« èŠ‚ç¼–è¾‘å™¨é€ç« æ“ä½œã€‚</p>
        {% else %}
        <p style="font-size: 13px; color: #e67e22;">âš  è¯·å…ˆå®Œæˆæ­¥éª¤3ç”Ÿæˆå¤§çº²ï¼Œæ‰èƒ½è¿›è¡Œé€ç« ç»†çº²ç¼–è¾‘ã€‚</p>
        {% endif %}
    </div>

    <div id="step4-result" class="result-box" style="display: none;"></div>
</div>

<!-- è¿›å…¥ç« èŠ‚åˆ›ä½œåŒº -->
{% if chapters_count > 0 %}
<div class="enter-editor-banner">
    <div>
        <h3>è¿›å…¥ç« èŠ‚åˆ›ä½œ</h3>
        <p>å‰ç½®å·¥ä½œæµå®Œæˆåï¼Œåœ¨ç« èŠ‚ç¼–è¾‘å™¨ä¸­é€ç« åˆ›ä½œã€è´¨é‡æ£€æŸ¥å’Œå‘é‡åŒ–ç®¡ç†ã€‚</p>
    </div>
    <a href="/novels/editor/{{ novel.id }}" class="btn" style="background: white; color: #2980b9; font-weight: bold; flex-shrink: 0;">
        è¿›å…¥ç« èŠ‚ç¼–è¾‘å™¨ â†’
    </a>
</div>
{% else %}
<div class="card" style="text-align: center; padding: 20px; color: #7f8c8d;">
    <p>å®Œæˆæ­¥éª¤3ï¼ˆç”Ÿæˆå¤§çº²ï¼‰åï¼Œå³å¯è¿›å…¥ç« èŠ‚ç¼–è¾‘å™¨è¿›è¡Œç« èŠ‚åˆ›ä½œã€‚</p>
</div>
{% endif %}

{% endblock %}

{% block extra_scripts %}
<script>
/* åˆ‡æ¢ AI/æ‰‹åŠ¨ è¾“å…¥æ¨¡å¼ */
function switchMode(step, mode, btn) {
    const aiEl = document.getElementById(`${step}-ai-mode`);
    const manualEl = document.getElementById(`${step}-manual-mode`);
    const tabs = btn.parentElement.querySelectorAll('.input-mode-tab');
    tabs.forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    if (mode === 'ai') {
        aiEl.style.display = '';
        manualEl.style.display = 'none';
    } else {
        aiEl.style.display = 'none';
        manualEl.style.display = '';
    }
}

/* æ­¥éª¤3 æ‰‹åŠ¨ä¿å­˜ï¼ˆæç¤ºï¼‰ */
function saveStep3Manual() {
    const text = document.getElementById('step3-manual-text').value.trim();
    if (!text) return;
    const result = document.getElementById('step3-result');
    result.style.display = 'block';
    result.textContent = 'âš  æ‰‹åŠ¨å¤§çº²æš‚ä¸æ”¯æŒè‡ªåŠ¨è§£æä¸ºå·/ç« èŠ‚ç»“æ„ï¼Œè¯·ä½¿ç”¨ AI ç”Ÿæˆåå†ç¼–è¾‘ï¼Œæˆ–ç›´æ¥åœ¨ç« èŠ‚ç¼–è¾‘å™¨ä¸­ç®¡ç†ç« èŠ‚ã€‚';
}

/* æœ‰ç»“æœæ—¶è‡ªåŠ¨æ˜¾ç¤º result-box */
document.body.addEventListener('htmx:afterSwap', function(evt) {
    const target = evt.detail.target;
    if (target && target.classList.contains('result-box')) {
        if (target.innerHTML.trim()) {
            target.style.display = 'block';
        }
    }
});

/* å°† JSON å“åº”æ ¼å¼åŒ–æ˜¾ç¤º */
document.body.addEventListener('htmx:beforeSwap', function(evt) {
    const ct = evt.detail.xhr.getResponseHeader('content-type') || '';
    if (ct.includes('application/json')) {
        try {
            const json = JSON.parse(evt.detail.serverResponse);
            evt.detail.serverResponse = '<pre>' + JSON.stringify(json, null, 2) + '</pre>';
        } catch(e) {}
    }
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}{{ novel.title }} - ç« èŠ‚ç¼–è¾‘å™¨{% endblock %}

{% block extra_head %}
<style>
/* æ•´ä½“å¸ƒå±€ï¼šå·¦ä¾§æ ‘ + å³ä¾§ç¼–è¾‘åŒº */
.editor-layout {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: 16px;
    align-items: start;
}

/* å·¦ä¾§ç« èŠ‚æ ‘ */
.chapter-tree {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    overflow: hidden;
    position: sticky;
    top: 16px;
    max-height: calc(100vh - 120px);
    display: flex;
    flex-direction: column;
}
.chapter-tree-header {
    padding: 12px 14px;
    background: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
    font-weight: bold;
    font-size: 13px;
    color: #2c3e50;
}
.chapter-tree-body {
    overflow-y: auto;
    flex: 1;
}

/* å·èŠ‚ç‚¹ */
.volume-node {
    border-bottom: 1px solid #f0f0f0;
}
.volume-label {
    display: flex;
    align-items: center;
    padding: 8px 14px;
    font-size: 13px;
    font-weight: bold;
    color: #2c3e50;
    background: #f8f9fa;
    cursor: pointer;
    user-select: none;
}
.volume-label:hover { background: #ecf0f1; }
.volume-toggle {
    margin-right: 6px;
    font-size: 10px;
    color: #95a5a6;
    transition: transform 0.15s;
}
.volume-toggle.collapsed { transform: rotate(-90deg); }

/* ç« èŠ‚èŠ‚ç‚¹ */
.chapter-list { padding: 4px 0; }
.chapter-item {
    display: flex;
    align-items: center;
    padding: 6px 14px 6px 28px;
    font-size: 13px;
    color: #555;
    cursor: pointer;
    border-left: 3px solid transparent;
    transition: all 0.1s;
}
.chapter-item:hover { background: #f0f7ff; color: #2980b9; }
.chapter-item.active {
    background: #ebf5fb;
    border-left-color: #3498db;
    color: #2980b9;
    font-weight: 500;
}
.chapter-item .chapter-status {
    margin-left: auto;
    font-size: 10px;
    flex-shrink: 0;
}
.status-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    display: inline-block;
}
.status-dot.has-content  { background: #27ae60; }
.status-dot.has-outline  { background: #f39c12; }
.status-dot.empty        { background: #ddd; }

/* å³ä¾§ç¼–è¾‘åŒº */
.editor-panel {
    min-height: 600px;
}
.editor-empty {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 400px;
    color: #95a5a6;
    font-size: 14px;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
}

/* ç« èŠ‚ä¿¡æ¯å¤´ */
.chapter-info-bar {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 14px 18px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.chapter-info-bar h3 { margin: 0; font-size: 16px; }
.chapter-info-bar .meta { font-size: 12px; color: #7f8c8d; margin-top: 3px; }

/* æ“ä½œæŒ‰é’®ç»„ */
.action-group {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 14px 18px;
    margin-bottom: 12px;
}
.action-group-title {
    font-size: 12px;
    font-weight: bold;
    color: #7f8c8d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 10px;
}
.action-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

/* å†…å®¹å±•ç¤ºåŒº */
.content-panel {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 18px;
    margin-bottom: 12px;
}
.content-panel-title {
    font-size: 13px;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.content-text {
    font-size: 14px;
    line-height: 1.8;
    color: #333;
    white-space: pre-wrap;
    max-height: 400px;
    overflow-y: auto;
}
.content-empty {
    color: #bdc3c7;
    font-size: 13px;
    font-style: italic;
}

/* ç»“æœæ¡† */
.result-box {
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 14px;
    margin-top: 10px;
    white-space: pre-wrap;
    font-size: 13px;
    line-height: 1.7;
    max-height: 300px;
    overflow-y: auto;
}

/* spinner */
.htmx-request .spinner-inline { display: inline-block !important; }
.spinner-inline {
    display: none;
    width: 14px; height: 14px;
    border: 2px solid #ccc;
    border-top-color: #3498db;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    vertical-align: middle;
    margin-left: 6px;
}

/* æŒ‰é’®å°ºå¯¸å˜ä½“ */
.btn-sm {
    padding: 5px 12px;
    font-size: 12px;
}
.btn-danger { background: #e74c3c; }
.btn-danger:hover { background: #c0392b; }
.btn-warning { background: #f39c12; }
.btn-warning:hover { background: #d68910; }
.btn-info { background: #16a085; }
.btn-info:hover { background: #1a8a72; }
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 14px; display: flex; align-items: center; gap: 16px;">
    <a href="/novels/view/{{ novel.id }}" style="color: #3498db; text-decoration: none;">â† è¿”å›é¡¹ç›®è¯¦æƒ…</a>
    <span style="color: #ddd;">|</span>
    <span style="font-size: 14px; color: #2c3e50; font-weight: 500;">ğŸ“– {{ novel.title }}</span>
    <span style="font-size: 12px; color: #7f8c8d;">ç« èŠ‚ç¼–è¾‘å™¨</span>
</div>

<div class="editor-layout">
    <!-- å·¦ä¾§ï¼šç« èŠ‚æ ‘ -->
    <div class="chapter-tree">
        <div class="chapter-tree-header">
            ç« èŠ‚ç»“æ„
            <span style="font-weight: normal; color: #7f8c8d; font-size: 12px; margin-left: 6px;">
                {{ chapters_count }} ç« 
            </span>
        </div>
        <div class="chapter-tree-body">
            {% for volume in volumes %}
            <div class="volume-node">
                <div class="volume-label" onclick="toggleVolume({{ volume.id }})">
                    <span class="volume-toggle" id="toggle-{{ volume.id }}">â–¼</span>
                    ç¬¬{{ volume.order }}å· {{ volume.title }}
                </div>
                <div class="chapter-list" id="vol-chapters-{{ volume.id }}">
                    {% for chapter in volume.chapters | sort(attribute='order') %}
                    <div class="chapter-item"
                         id="chapter-item-{{ chapter.id }}"
                         onclick="selectChapter({{ chapter.id }}, {{ volume.id }}, '{{ chapter.title | e }}', {{ chapter.order }}, '{{ volume.title | e }}')">
                        <span style="margin-right: 6px; color: #bdc3c7; font-size: 11px;">{{ chapter.order }}</span>
                        {{ chapter.title }}
                        <span class="chapter-status">
                            {% if chapter.content %}
                            <span class="status-dot has-content" title="å·²ç”Ÿæˆæ­£æ–‡"></span>
                            {% elif chapter.detail_outline %}
                            <span class="status-dot has-outline" title="å·²æœ‰ç»†çº²"></span>
                            {% else %}
                            <span class="status-dot empty" title="æœªå¼€å§‹"></span>
                            {% endif %}
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div style="padding: 20px; text-align: center; color: #bdc3c7; font-size: 13px;">
                æš‚æ— ç« èŠ‚<br>è¯·å…ˆå®Œæˆæ­¥éª¤3ç”Ÿæˆå¤§çº²
            </div>
            {% endfor %}
        </div>
        <!-- å›¾ä¾‹ -->
        <div style="padding: 10px 14px; border-top: 1px solid #f0f0f0; font-size: 11px; color: #95a5a6; display: flex; gap: 12px;">
            <span><span class="status-dot has-content" style="display:inline-block;"></span> å·²åˆ›ä½œ</span>
            <span><span class="status-dot has-outline" style="display:inline-block;"></span> æœ‰ç»†çº²</span>
            <span><span class="status-dot empty" style="display:inline-block;"></span> æœªå¼€å§‹</span>
        </div>
    </div>

    <!-- å³ä¾§ï¼šç¼–è¾‘æ“ä½œåŒº -->
    <div class="editor-panel" id="editor-panel">
        <div class="editor-empty" id="editor-empty">
            â† ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªç« èŠ‚å¼€å§‹åˆ›ä½œ
        </div>

        <!-- ç« èŠ‚æ“ä½œåŒºï¼ˆé€‰ä¸­ç« èŠ‚åæ˜¾ç¤ºï¼‰ -->
        <div id="chapter-workspace" style="display: none;">

            <!-- ç« èŠ‚ä¿¡æ¯å¤´ -->
            <div class="chapter-info-bar">
                <div>
                    <h3 id="ws-chapter-title">ç« èŠ‚æ ‡é¢˜</h3>
                    <div class="meta" id="ws-chapter-meta">ç¬¬Xå· Â· ç¬¬Xç« </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-sm" style="background: #7f8c8d;"
                            onclick="prevChapter()">â† ä¸Šä¸€ç« </button>
                    <button class="btn btn-sm" style="background: #7f8c8d;"
                            onclick="nextChapter()">ä¸‹ä¸€ç«  â†’</button>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’®ç»„ï¼šåˆ›ä½œ -->
            <div class="action-group">
                <div class="action-group-title">ç« èŠ‚åˆ›ä½œ</div>
                <div class="action-buttons">
                    <button class="btn btn-sm" id="btn-write"
                            onclick="doWrite()">
                        ç« èŠ‚åˆ›ä½œ
                        <span class="spinner-inline" id="spinner-write"></span>
                    </button>
                    <button class="btn btn-sm btn-warning" id="btn-outline"
                            onclick="doDetailOutline()">
                        ç”Ÿæˆç»†çº²
                        <span class="spinner-inline" id="spinner-outline"></span>
                    </button>
                    <div style="display: flex; gap: 6px; align-items: center;">
                        <input type="text" id="style-guide-input"
                               placeholder="é£æ ¼æŒ‡å—ï¼ˆå¯é€‰ï¼‰"
                               style="width: 180px; padding: 5px 10px; font-size: 12px; margin-bottom: 0;">
                    </div>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’®ç»„ï¼šæ£€æŸ¥ -->
            <div class="action-group">
                <div class="action-group-title">è´¨é‡ä¸ä¸€è‡´æ€§</div>
                <div class="action-buttons">
                    <button class="btn btn-sm btn-info" id="btn-quality"
                            onclick="doQualityCheck()">
                        è´¨é‡æ£€æŸ¥
                        <span class="spinner-inline" id="spinner-quality"></span>
                    </button>
                    <button class="btn btn-sm btn-info" id="btn-consistency"
                            onclick="doConsistencyCheck()">
                        ä¸€è‡´æ€§æ£€æŸ¥
                        <span class="spinner-inline" id="spinner-consistency"></span>
                    </button>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’®ç»„ï¼šæ”¹å†™ä¸å›æ»š -->
            <div class="action-group">
                <div class="action-group-title">æ”¹å†™ / å›æ»š</div>
                <div class="action-buttons">
                    <button class="btn btn-sm btn-danger"
                            onclick="doRewrite()">
                        é‡å†™æœ¬ç« 
                        <span class="spinner-inline" id="spinner-rewrite"></span>
                    </button>
                    <button class="btn btn-sm" style="background: #7f8c8d;"
                            onclick="doRollback()">
                        å›æ»šä¸Šä¸€ç‰ˆ
                        <span class="spinner-inline" id="spinner-rollback"></span>
                    </button>
                </div>
                <div style="margin-top: 8px;">
                    <input type="text" id="rewrite-instruction"
                           placeholder="æ”¹å†™æŒ‡ä»¤ï¼ˆå¦‚ï¼šåŠ å¼ºå†²çªæ„Ÿã€ç²¾ç®€å¯¹è¯ï¼‰"
                           style="width: 100%; padding: 5px 10px; font-size: 12px; margin-bottom: 0;">
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’®ç»„ï¼šæµæ°´çº¿ -->
            <div class="action-group">
                <div class="action-group-title">æµæ°´çº¿</div>
                <div class="action-buttons">
                    <button class="btn btn-sm btn-success"
                            onclick="doPipelineRun()">
                        æ‰¹é‡è¿è¡Œæµæ°´çº¿
                        <span class="spinner-inline" id="spinner-pipeline"></span>
                    </button>
                </div>
                <div style="font-size: 11px; color: #95a5a6; margin-top: 6px;">
                    è‡ªåŠ¨æ‰§è¡Œï¼šå¤§çº² â†’ ç»†çº² â†’ æ­£æ–‡ï¼Œè·³è¿‡å·²å®Œæˆç« èŠ‚ã€‚
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’®ç»„ï¼šå‘é‡åŒ– -->
            <div class="action-group">
                <div class="action-group-title">å‘é‡åŒ– / RAG</div>
                <div class="action-buttons">
                    <button class="btn btn-sm" style="background: #8e44ad;"
                            onclick="doVectorize()">
                        å‘é‡åŒ–
                        <span class="spinner-inline" id="spinner-vec"></span>
                    </button>
                    <button class="btn btn-sm" style="background: #6c3483;"
                            onclick="doRevectorize()">
                        é‡æ–°å‘é‡åŒ–
                    </button>
                </div>
                <div style="font-size: 11px; color: #95a5a6; margin-top: 6px;">
                    å‘é‡åŒ–åï¼Œç« èŠ‚å†…å®¹å°†è¢«ç´¢å¼•ç”¨äºåç»­ç« èŠ‚çš„ä¸Šä¸‹æ–‡æ£€ç´¢ã€‚
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’®ç»„ï¼šä¸Šä¸‹æ–‡å‹ç¼© -->
            <div class="action-group">
                <div class="action-group-title">ä¸Šä¸‹æ–‡å‹ç¼©</div>
                <div class="action-buttons">
                    <button class="btn btn-sm" style="background: #2980b9;"
                            onclick="doCompressSummaries(false)">
                        æ‰¹é‡å‹ç¼©æ‘˜è¦
                        <span class="spinner-inline" id="spinner-compress"></span>
                    </button>
                    <button class="btn btn-sm" style="background: #1a5276;"
                            onclick="doCompressSummaries(true)">
                        å¼ºåˆ¶é‡æ–°å‹ç¼©
                    </button>
                </div>
                <div style="font-size: 11px; color: #95a5a6; margin-top: 6px;">
                    å¯¹å·²ç”Ÿæˆæ­£æ–‡çš„ç« èŠ‚ç”Ÿæˆæ‘˜è¦ç¼“å­˜ï¼Œæå‡åç»­ç« èŠ‚åˆ›ä½œçš„ä¸Šä¸‹æ–‡è´¨é‡ã€‚
                </div>
            </div>

            <!-- æ“ä½œç»“æœ -->
            <div id="action-result" class="result-box" style="display: none; margin-bottom: 12px;"></div>

            <!-- ç»†çº²å†…å®¹ -->
            <div class="content-panel" id="panel-outline" style="display: none;">
                <div class="content-panel-title">
                    <span>ç»†çº²</span>
                    <button class="btn btn-sm" style="background: #f39c12; font-size: 11px; padding: 3px 8px;"
                            onclick="toggleEditOutline()">ç¼–è¾‘</button>
                </div>
                <div id="outline-view" class="content-text"></div>
                <textarea id="outline-edit" style="display:none; min-height: 160px; font-size: 13px;"></textarea>
                <div id="outline-edit-actions" style="display:none; margin-top: 8px;">
                    <button class="btn btn-sm btn-success" onclick="saveOutline()">ä¿å­˜ç»†çº²</button>
                    <button class="btn btn-sm" style="background: #7f8c8d;" onclick="cancelEditOutline()">å–æ¶ˆ</button>
                </div>
            </div>

            <!-- æ­£æ–‡å†…å®¹ -->
            <div class="content-panel" id="panel-content" style="display: none;">
                <div class="content-panel-title">
                    <span>æ­£æ–‡</span>
                    <span id="content-word-count" style="font-size: 11px; color: #7f8c8d; font-weight: normal;"></span>
                </div>
                <div id="content-view" class="content-text"></div>
            </div>

        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
const NOVEL_ID = {{ novel.id }};

/* ç« èŠ‚æ ‘æ•°æ®ï¼ˆä»æ¨¡æ¿æ¸²æŸ“ï¼‰ */
const volumeData = [
    {% for volume in volumes %}
    {
        id: {{ volume.id }},
        order: {{ volume.order }},
        title: "{{ volume.title | e }}",
        chapters: [
            {% for chapter in volume.chapters | sort(attribute='order') %}
            {
                id: {{ chapter.id }},
                order: {{ chapter.order }},
                title: "{{ chapter.title | e }}",
                hasContent: {{ 'true' if chapter.content else 'false' }},
                hasOutline: {{ 'true' if chapter.detail_outline else 'false' }},
                wordCount: {{ chapter.word_count or 0 }}
            },
            {% endfor %}
        ]
    },
    {% endfor %}
];

/* å½“å‰é€‰ä¸­çŠ¶æ€ */
let currentChapterId = null;
let currentVolumeIdx = 0;
let currentChapterIdx = 0;

/* å±•å¼€/æŠ˜å å· */
function toggleVolume(volumeId) {
    const list = document.getElementById(`vol-chapters-${volumeId}`);
    const toggle = document.getElementById(`toggle-${volumeId}`);
    if (list.style.display === 'none') {
        list.style.display = '';
        toggle.classList.remove('collapsed');
    } else {
        list.style.display = 'none';
        toggle.classList.add('collapsed');
    }
}

/* é€‰ä¸­ç« èŠ‚ */
function selectChapter(chapterId, volumeId, title, order, volumeTitle) {
    /* æ›´æ–°é«˜äº® */
    document.querySelectorAll('.chapter-item').forEach(el => el.classList.remove('active'));
    const item = document.getElementById(`chapter-item-${chapterId}`);
    if (item) item.classList.add('active');

    currentChapterId = chapterId;

    /* è®°å½•ä½ç½®ï¼Œç”¨äºä¸Šä¸‹ç« å¯¼èˆª */
    for (let vi = 0; vi < volumeData.length; vi++) {
        const ci = volumeData[vi].chapters.findIndex(c => c.id === chapterId);
        if (ci !== -1) { currentVolumeIdx = vi; currentChapterIdx = ci; break; }
    }

    /* æ›´æ–°æ ‡é¢˜æ  */
    document.getElementById('ws-chapter-title').textContent = title;
    document.getElementById('ws-chapter-meta').textContent =
        `ç¬¬${volumeData[currentVolumeIdx].order}å· ${volumeData[currentVolumeIdx].title} Â· ç¬¬${order}ç« `;

    /* æ˜¾ç¤ºå·¥ä½œåŒº */
    document.getElementById('editor-empty').style.display = 'none';
    document.getElementById('chapter-workspace').style.display = '';

    /* æ¸…ç©ºä¸Šæ¬¡ç»“æœ */
    hideResult();

    /* åŠ è½½ç« èŠ‚å†…å®¹ */
    loadChapterContent(chapterId);
}

/* åŠ è½½ç« èŠ‚å†…å®¹ï¼ˆç»†çº² + æ­£æ–‡ï¼‰ */
function loadChapterContent(chapterId) {
    fetch(`/workflow/chapter/${chapterId}/content`)
        .then(r => r.json())
        .then(data => {
            /* ç»†çº² */
            const panelOutline = document.getElementById('panel-outline');
            const outlineView = document.getElementById('outline-view');
            if (data.detail_outline) {
                outlineView.textContent = data.detail_outline;
                document.getElementById('outline-edit').value = data.detail_outline;
                panelOutline.style.display = '';
            } else {
                outlineView.innerHTML = '<span class="content-empty">æš‚æ— ç»†çº²ï¼Œå¯ç‚¹å‡»"ç”Ÿæˆç»†çº²"æŒ‰é’®ç”Ÿæˆã€‚</span>';
                document.getElementById('outline-edit').value = '';
                panelOutline.style.display = '';
            }

            /* æ­£æ–‡ */
            const panelContent = document.getElementById('panel-content');
            const contentView = document.getElementById('content-view');
            if (data.content) {
                contentView.textContent = data.content;
                document.getElementById('content-word-count').textContent = `${data.word_count || 0} å­—`;
                panelContent.style.display = '';
            } else {
                contentView.innerHTML = '<span class="content-empty">æš‚æ— æ­£æ–‡ï¼Œå¯ç‚¹å‡»"ç« èŠ‚åˆ›ä½œ"æŒ‰é’®ç”Ÿæˆã€‚</span>';
                document.getElementById('content-word-count').textContent = '';
                panelContent.style.display = '';
            }
        })
        .catch(() => {
            showResult('åŠ è½½ç« èŠ‚å†…å®¹å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•ã€‚');
        });
}

/* ç« èŠ‚åˆ›ä½œ */
function doWrite() {
    if (!currentChapterId) return;
    const styleGuide = document.getElementById('style-guide-input').value.trim();
    showSpinner('write');
    fetch(`/workflow/chapter/${currentChapterId}/step5`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ style_guide: styleGuide || null, authors_note: null })
    })
    .then(r => r.json())
    .then(data => {
        hideSpinner('write');
        showResult(JSON.stringify(data, null, 2));
        /* åˆ·æ–°å†…å®¹åŒº */
        loadChapterContent(currentChapterId);
        /* æ›´æ–°æ ‘çŠ¶æ€ç‚¹ */
        updateTreeDot(currentChapterId, 'has-content');
    })
    .catch(e => { hideSpinner('write'); showResult('è¯·æ±‚å¤±è´¥ï¼š' + e); });
}

/* ç”Ÿæˆç»†çº² */
function doDetailOutline() {
    if (!currentChapterId) return;
    showSpinner('outline');
    fetch(`/workflow/chapter/${currentChapterId}/step4`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        hideSpinner('outline');
        showResult(JSON.stringify(data, null, 2));
        loadChapterContent(currentChapterId);
        updateTreeDot(currentChapterId, 'has-outline');
    })
    .catch(e => { hideSpinner('outline'); showResult('è¯·æ±‚å¤±è´¥ï¼š' + e); });
}

/* è´¨é‡æ£€æŸ¥ */
function doQualityCheck() {
    if (!currentChapterId) return;
    showSpinner('quality');
    fetch(`/workflow/chapter/${currentChapterId}/step6`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        hideSpinner('quality');
        showResult(JSON.stringify(data, null, 2));
    })
    .catch(e => { hideSpinner('quality'); showResult('è¯·æ±‚å¤±è´¥ï¼š' + e); });
}

/* ä¸€è‡´æ€§æ£€æŸ¥ */
function doConsistencyCheck() {
    if (!currentChapterId) return;
    showSpinner('consistency');
    fetch(`/workflow/chapter/${currentChapterId}/consistency-check`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ content_override: null, strict: false })
    })
    .then(r => r.json())
    .then(data => {
        hideSpinner('consistency');
        showResult(JSON.stringify(data, null, 2));
    })
    .catch(e => { hideSpinner('consistency'); showResult('è¯·æ±‚å¤±è´¥ï¼š' + e); });
}

/* é‡å†™æœ¬ç«  */
function doRewrite() {
    if (!currentChapterId) return;
    const instruction = document.getElementById('rewrite-instruction').value.trim();
    if (!instruction) { showResult('è¯·å…ˆå¡«å†™æ”¹å†™æŒ‡ä»¤'); return; }
    showSpinner('rewrite');
    fetch(`/workflow/chapter/${currentChapterId}/rewrite`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ instruction, target_scope: 'full', preserve_plot: true, rewrite_mode: 'rewrite', save: true })
    })
    .then(r => r.json())
    .then(data => {
        hideSpinner('rewrite');
        showResult(JSON.stringify(data, null, 2));
        loadChapterContent(currentChapterId);
    })
    .catch(e => { hideSpinner('rewrite'); showResult('è¯·æ±‚å¤±è´¥ï¼š' + e); });
}

/* å›æ»šä¸Šä¸€ç‰ˆï¼ˆhistory_id ä¼  nullï¼Œåç«¯è‡ªåŠ¨å–æœ€è¿‘ä¸€æ¡ï¼‰ */
function doRollback() {
    if (!currentChapterId) return;
    showSpinner('rollback');
    fetch(`/workflow/chapter/${currentChapterId}/rewrite/rollback`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ history_id: null, save: true })
    })
    .then(r => r.json())
    .then(data => {
        hideSpinner('rollback');
        showResult(JSON.stringify(data, null, 2));
        loadChapterContent(currentChapterId);
    })
    .catch(e => { hideSpinner('rollback'); showResult('è¯·æ±‚å¤±è´¥ï¼š' + e); });
}

/* æ‰¹é‡æµæ°´çº¿è¿è¡Œ */
function doPipelineRun() {
    showSpinner('pipeline');
    fetch(`/workflow/${NOVEL_ID}/pipeline/run`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ from_step: 3, to_step: 5, regenerate: false, max_workers: 1 })
    })
    .then(r => r.json())
    .then(data => {
        hideSpinner('pipeline');
        showResult(JSON.stringify(data, null, 2));
    })
    .catch(e => { hideSpinner('pipeline'); showResult('è¯·æ±‚å¤±è´¥ï¼š' + e); });
}

/* æ‰¹é‡å‹ç¼©æ‘˜è¦ */
function doCompressSummaries(force) {
    showSpinner('compress');
    fetch(`/workflow/${NOVEL_ID}/compress-summaries?force=${force}`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        hideSpinner('compress');
        showResult(JSON.stringify(data, null, 2));
    })
    .catch(e => { hideSpinner('compress'); showResult('è¯·æ±‚å¤±è´¥ï¼š' + e); });
}

/* å‘é‡åŒ–ï¼ˆå¯¹æ•´éƒ¨å°è¯´çš„ä¼ç¬”è¿›è¡Œç´¢å¼•ï¼‰ */
function doVectorize() {
    showSpinner('vec');
    fetch(`/workflow/${NOVEL_ID}/vectorize`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        hideSpinner('vec');
        showResult(JSON.stringify(data, null, 2));
    })
    .catch(e => { hideSpinner('vec'); showResult('è¯·æ±‚å¤±è´¥ï¼š' + e); });
}

/* é‡æ–°å‘é‡åŒ–ï¼ˆå¼ºåˆ¶é‡å»ºæ‰€æœ‰ä¼ç¬”ç´¢å¼•ï¼‰ */
function doRevectorize() {
    showSpinner('vec');
    fetch(`/workflow/${NOVEL_ID}/vectorize?force=true`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        hideSpinner('vec');
        showResult(JSON.stringify(data, null, 2));
    })
    .catch(e => { hideSpinner('vec'); showResult('è¯·æ±‚å¤±è´¥ï¼š' + e); });
}

/* ç»†çº²ç¼–è¾‘ */
function toggleEditOutline() {
    const view = document.getElementById('outline-view');
    const edit = document.getElementById('outline-edit');
    const actions = document.getElementById('outline-edit-actions');
    if (edit.style.display === 'none') {
        view.style.display = 'none';
        edit.style.display = '';
        actions.style.display = '';
    } else {
        cancelEditOutline();
    }
}

function cancelEditOutline() {
    document.getElementById('outline-view').style.display = '';
    document.getElementById('outline-edit').style.display = 'none';
    document.getElementById('outline-edit-actions').style.display = 'none';
}

function saveOutline() {
    if (!currentChapterId) return;
    const content = document.getElementById('outline-edit').value.trim();
    fetch(`/workflow/chapter/${currentChapterId}/outline`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ detail_outline: content })
    })
    .then(r => r.json())
    .then(() => {
        document.getElementById('outline-view').textContent = content;
        cancelEditOutline();
        showResult('âœ“ ç»†çº²å·²ä¿å­˜');
    })
    .catch(e => showResult('ä¿å­˜å¤±è´¥ï¼š' + e));
}

/* ä¸Šä¸‹ç« å¯¼èˆª */
function prevChapter() {
    const flat = flatChapters();
    const idx = flat.findIndex(c => c.id === currentChapterId);
    if (idx > 0) activateFlat(flat[idx - 1]);
}

function nextChapter() {
    const flat = flatChapters();
    const idx = flat.findIndex(c => c.id === currentChapterId);
    if (idx < flat.length - 1) activateFlat(flat[idx + 1]);
}

function flatChapters() {
    const result = [];
    for (const vol of volumeData) {
        for (const ch of vol.chapters) {
            result.push({ ...ch, volumeTitle: vol.title, volumeOrder: vol.order });
        }
    }
    return result;
}

function activateFlat(ch) {
    selectChapter(ch.id, null, ch.title, ch.order, ch.volumeTitle);
    /* ç¡®ä¿å¯¹åº”å·å±•å¼€ */
    const list = document.getElementById(`vol-chapters-${volumeData.find(v => v.chapters.some(c => c.id === ch.id))?.id}`);
    if (list) list.style.display = '';
}

/* æ›´æ–°æ ‘çŠ¶æ€ç‚¹ */
function updateTreeDot(chapterId, cls) {
    const item = document.getElementById(`chapter-item-${chapterId}`);
    if (!item) return;
    const dot = item.querySelector('.status-dot');
    if (dot) { dot.className = `status-dot ${cls}`; }
}

/* ç»“æœæ˜¾ç¤º */
function showResult(text) {
    const el = document.getElementById('action-result');
    el.textContent = text;
    el.style.display = '';
}
function hideResult() {
    const el = document.getElementById('action-result');
    el.style.display = 'none';
    el.textContent = '';
}

/* spinner æ§åˆ¶ */
function showSpinner(name) {
    const s = document.getElementById(`spinner-${name}`);
    if (s) s.style.display = 'inline-block';
}
function hideSpinner(name) {
    const s = document.getElementById(`spinner-${name}`);
    if (s) s.style.display = 'none';
}
</script>
{% endblock %}

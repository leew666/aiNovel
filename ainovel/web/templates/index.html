{% extends "base.html" %}

{% block title %}é¦–é¡µ{% endblock %}

{% block content %}
{% if not api_key_set %}
<div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 14px 18px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
    <span style="font-size: 14px; color: #856404;">âš ï¸ å½“å‰æä¾›å•† <strong>{{ llm_provider }}</strong> çš„ API Key æœªé…ç½®ï¼Œå·¥ä½œæµæ­¥éª¤å°†æ— æ³•æ‰§è¡Œã€‚</span>
    <a href="/settings/" class="btn" style="font-size: 13px; padding: 6px 14px; background: #e6a817;">å»é…ç½®</a>
</div>
{% else %}
<div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px; padding: 10px 18px; margin-bottom: 20px; font-size: 13px; color: #155724;">
    âœ“ å½“å‰æ¨¡å‹ï¼š<strong>{{ llm_provider }}</strong> / <strong>{{ llm_model }}</strong>
    &nbsp;&nbsp;<a href="/settings/" style="color: #155724; font-size: 12px;">ä¿®æ”¹</a>
</div>
{% endif %}

<div class="card">
    <h2>ğŸ“š æˆ‘çš„é¡¹ç›®</h2>

    <div style="margin-bottom: 20px;">
        <button class="btn btn-success" onclick="showCreateForm()">+ åˆ›å»ºæ–°é¡¹ç›®</button>
        <a href="/importer/" class="btn" style="margin-left: 8px;">å¯¼å…¥æ”¹å†™</a>
    </div>

    <!-- åˆ›å»ºé¡¹ç›®è¡¨å•ï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div id="create-form" style="display: none; margin-bottom: 30px; padding: 20px; background: #ecf0f1; border-radius: 4px;">
        <h3>åˆ›å»ºæ–°é¡¹ç›®</h3>
        <form hx-post="/novels/create-html" hx-target="#novels-list" hx-swap="beforeend" hx-on::after-request="onCreateSuccess(event)">
            <input type="text" name="title" placeholder="å°è¯´æ ‡é¢˜" required>
            <textarea name="description" placeholder="ç®€ä»‹æˆ–åˆå§‹æƒ³æ³•"></textarea>
            <input type="text" name="author" placeholder="ä½œè€…ï¼ˆé»˜è®¤ï¼šAIï¼‰" value="AI">
            <input type="text" name="genre" placeholder="ç±»å‹ï¼ˆå¦‚ï¼šç„å¹»ã€éƒ½å¸‚ï¼‰">

            <button type="submit" class="btn btn-success">åˆ›å»º</button>
            <button type="button" class="btn" onclick="hideCreateForm()">å–æ¶ˆ</button>
        </form>
    </div>

    <!-- å°è¯´åˆ—è¡¨ -->
    <div id="novels-list"
         hx-get="/novels/list-html"
         hx-trigger="load"
         hx-swap="innerHTML">
        <div class="loading">
            <div class="spinner"></div>
            <p>åŠ è½½ä¸­...</p>
        </div>
    </div>
</div>

<script>
function showCreateForm() {
    document.getElementById('create-form').style.display = 'block';
}

function hideCreateForm() {
    document.getElementById('create-form').style.display = 'none';
}

function onCreateSuccess(event) {
    if (event.detail.successful) {
        hideCreateForm();
        // ç§»é™¤ç©ºçŠ¶æ€æç¤º
        const empty = document.querySelector('#novels-list [style*="text-align: center"]');
        if (empty) empty.remove();
    }
}
</script>
{% endblock %}
